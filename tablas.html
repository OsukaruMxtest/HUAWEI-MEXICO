<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabla de Posiciones - PUBG MOBILE COPA HUAWEI MÉXICO</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        :root{--primary:#BB0215;--card-bg:rgba(255,255,255,0.88);--card-border:rgba(0,0,0,0.08);--text:#1a1a1a}
        *{box-sizing:border-box;margin:0;padding:0}
        
        #background-video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
            filter: brightness(0.8);
        }
        
        body{font-family:'Poppins',sans-serif;color:var(--text);min-height:100vh;position:relative}
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4);
            z-index: -1;
        }
        
        header{position:fixed;left:0;top:0;width:100%;background:var(--card-bg);backdrop-filter:blur(10px);border-bottom:1px solid var(--card-border);z-index:1000;padding:1rem;box-shadow:0 2px 15px rgba(0,0,0,0.1)}
        nav{display:flex;justify-content:space-between;align-items:center}
        .logo{font-size:1.2rem;font-weight:700;color:var(--primary);text-transform:uppercase;letter-spacing:1px}
        .nav-links{display:flex;gap:1.5rem}
        .nav-links a{color:var(--text);text-decoration:none;font-weight:500;transition:all 0.3s ease;position:relative;padding:0.5rem 0}
        .nav-links a:hover{color:var(--primary)}
        .nav-links a::after{content:'';position:absolute;bottom:0;left:0;width:0;height:2px;background:var(--primary);transition:width 0.3s ease}
        .nav-links a:hover::after{width:100%}
        main{margin-top:80px;padding:1rem}
        .glass-card{background:var(--card-bg);padding:1rem;border-radius:12px;border:1px solid var(--card-border);box-shadow:0 8px 25px rgba(0,0,0,0.1);backdrop-filter:blur(8px)}
        .tabs{display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:1rem}
        .tab{padding:.6rem 1rem;border-radius:8px;border:none;background:transparent;cursor:pointer;transition:all 0.3s ease;font-size:0.9rem}
        .tab.active{color:var(--primary);border-bottom:3px solid var(--primary);font-weight:600}
        .phases{display:flex;gap:.5rem;margin:1rem 0;flex-wrap:wrap}
        .phase-btn{padding:.5rem .9rem;border-radius:8px;border:1px solid var(--card-border);cursor:pointer;background:transparent;transition:all 0.3s ease;font-size:0.85rem}
        .phase-btn.active{background:rgba(187,2,21,0.12);border-color:var(--primary);color:var(--primary);font-weight:600;box-shadow:0 2px 8px rgba(187,2,21,0.2)}
        .semifinal-selector{display:flex;gap:.5rem;margin:1rem 0;flex-wrap:wrap}
        .semifinal-btn{padding:.5rem .9rem;border-radius:8px;border:1px solid var(--card-border);cursor:pointer;background:transparent;transition:all 0.3s ease;font-size:0.85rem}
        .semifinal-btn.active{background:rgba(187,2,21,0.12);border-color:var(--primary);color:var(--primary);font-weight:600;box-shadow:0 2px 8px rgba(187,2,21,0.2)}
        .table-container{overflow-x:auto;margin-top:.75rem;border-radius:10px;padding:10px;max-width:100%}
        
        table{border-collapse:collapse;width:100%;border-radius:12px;overflow:hidden;box-shadow:0 6px 20px rgba(0,0,0,0.12);background:var(--card-bg);border:1px solid rgba(0,0,0,0.08);min-width:800px}
        th,td{padding:.8rem .5rem;text-align:left;border-bottom:1px solid rgba(0,0,0,0.08);white-space:nowrap;transition:all 0.2s ease;font-size:0.85rem}
        .center{text-align:center}
        th{background:linear-gradient(135deg, rgba(187,2,21,0.15), rgba(187,2,21,0.1));font-weight:700;color:var(--primary);position:sticky;top:0;font-size:0.8rem;text-transform:uppercase;letter-spacing:0.8px;border-bottom:2px solid var(--primary)}
        tr:hover td{background:rgba(187,2,21,0.05)}
        .highlight{background:rgba(46,125,50,0.12);font-weight:600;border-left:4px solid #2e7d32}
        .highlight:hover td{background:rgba(46,125,50,0.18)}
        .top3-1{background:linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,215,0,0.1));font-weight:700;border-left:4px solid gold}
        .top3-2{background:linear-gradient(135deg, rgba(192,192,192,0.2), rgba(192,192,192,0.1));font-weight:600;border-left:4px solid silver}
        .top3-3{background:linear-gradient(135deg, rgba(205,127,50,0.2), rgba(205,127,50,0.1));font-weight:600;border-left:4px solid #cd7f32}
        
        .logo-img{width:28px;height:28px;object-fit:contain;border-radius:6px;transition:transform 0.3s ease, box-shadow 0.3s ease;border:1px solid rgba(0,0,0,0.1)}
        .player-img{width:24px;height:24px;border-radius:50%;object-fit:cover;transition:transform 0.3s ease, box-shadow 0.3s ease;border:1px solid rgba(0,0,0,0.1)}
        .logo-img:hover, .player-img:hover{transform:scale(2.5);z-index:10;box-shadow:0 8px 20px rgba(0,0,0,0.3)}
        
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:1rem;margin-top:1rem}
        .stat-card{padding:.75rem;border-radius:8px;font-size:0.9rem}
        
        .hamburger {
            display: none;
            flex-direction: column;
            cursor: pointer;
            width: 30px;
            height: 21px;
            justify-content: space-between;
        }

        .hamburger span {
            width: 100%;
            height: 3px;
            background-color: var(--primary);
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        @media (max-width: 768px) {
            header {
                padding: 0.8rem;
            }
            
            .logo {
                font-size: 1rem;
            }
            
            .nav-links {
                position: absolute;
                top: 60px;
                left: 0;
                width: 100%;
                background: var(--card-bg);
                backdrop-filter: blur(10px);
                border-bottom: 1px solid var(--card-border);
                flex-direction: column;
                align-items: center;
                padding: 1rem 0;
                gap: 1rem;
                box-shadow: 0 4px 10px rgba(0,0,0,0.1);
                display: none;
            }

            .nav-links.active {
                display: flex;
            }

            .hamburger {
                display: flex;
            }

            .hamburger.active span:nth-child(1) {
                transform: rotate(45deg) translate(6px, 6px);
            }

            .hamburger.active span:nth-child(2) {
                opacity: 0;
            }

            .hamburger.active span:nth-child(3) {
                transform: rotate(-45deg) translate(6px, -6px);
            }
            
            main {
                margin-top: 60px;
                padding: 0.8rem;
            }
            
            .glass-card {
                padding: 0.8rem;
            }
            
            th, td {
                padding: 0.5rem 0.3rem;
                font-size: 0.75rem;
            }
            
            .tab {
                padding: 0.5rem 0.8rem;
                font-size: 0.8rem;
            }
            
            .phase-btn, .semifinal-btn {
                padding: 0.4rem 0.7rem;
                font-size: 0.8rem;
            }
            
            .logo-img {
                width: 24px;
                height: 24px;
            }
            
            .player-img {
                width: 20px;
                height: 20px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 0.8rem;
            }
            
            .table-container {
                padding: 5px;
                margin-top: 0.5rem;
            }
            
            table {
                min-width: 700px;
            }
        }

        @media (max-width: 480px) {
            .logo {
                font-size: 0.9rem;
            }
            
            main {
                padding: 0.5rem;
            }
            
            .glass-card {
                padding: 0.6rem;
            }
            
            th, td {
                padding: 0.4rem 0.2rem;
                font-size: 0.7rem;
            }
            
            .tab {
                padding: 0.4rem 0.6rem;
                font-size: 0.75rem;
            }
            
            .phase-btn, .semifinal-btn {
                padding: 0.3rem 0.5rem;
                font-size: 0.75rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 0.6rem;
            }
            
            .table-container {
                padding: 3px;
            }
            
            table {
                min-width: 650px;
            }
            
            h1 {
                font-size: 1.2rem;
            }
            
            h2 {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
<video id="background-video" autoplay muted loop>
    <source src="https://res.cloudinary.com/dxtvsnw3g/video/upload/v1763772374/fondo_g1hfuz.mp4" type="video/mp4">
</video>

<header>
    <nav>
        <div class="logo">PUBG MOBILE COPA HUAWEI MÉXICO</div>
        <div class="nav-links" id="nav-links">
            <a href="index.html">Inicio</a>
            <a href="grupos.html">Grupos</a>
            <a href="fases.html">Fases</a>
            <a href="tablas.html" style="color: var(--primary);">Tabla</a>
            <a href="equipos.html">Equipos</a>
            <a href="jugadores.html">Jugadores</a>
            <a href="mapas.html">Mapas</a>
        </div>
        <div class="hamburger" id="hamburger">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </nav>
</header>
<main>
    <div class="glass-card">
        <h1>Tabla de Posiciones, MVP y MVT</h1>
    </div>

    <div class="tabs glass-card" style="margin-top:1rem">
        <button class="tab active" data-tab="tabla">Tabla de Posiciones</button>
        <button class="tab" data-tab="mvp">MVP/MVT</button>
    </div>

    <div class="glass-card" style="margin-top:.75rem">
        <div class="phases">
            <button class="phase-btn active" data-phase="Clasificatorias">Clasificatorias</button>
            <button class="phase-btn" data-phase="Semifinal">Semifinal</button>
            <button class="phase-btn" data-phase="Final">Final</button>
        </div>

        <div id="semifinal-selector" class="semifinal-selector" style="display:none">
            <button class="semifinal-btn active" data-group="1">Semifinal 1</button>
            <button class="semifinal-btn" data-group="2">Semifinal 2</button>
        </div>

        <div id="phase-mvp-mvt" style="display:flex;gap:1rem;flex-wrap:wrap">
            <div class="glass-card stat-card" style="min-width:280px">
                <div style="font-weight:600">MVP (Jugador)</div>
                <div id="phase-mvp-name">-</div>
                <div id="phase-mvp-team" style="font-size:.85rem;color:#777"></div>
                <div id="phase-mvp-stats" style="font-size:.9rem;color:#555"></div>
            </div>
        </div>

        <div id="tabla-content" class="tab-content active" style="margin-top:1rem">
            <h2>Tabla de Posiciones — <span id="current-phase">Clasificatorias</span></h2>
            <div class="table-container">
                <table id="positions-table">
                    <thead>
                        <tr>
                            <th class="center">POS</th>
                            <th class="center">Logo</th>
                            <th>EQUIPO</th>
                            <th class="center">Puntos por Posición</th>
                            <th class="center">Puntos por Eliminación</th>
                            <th class="center">Puntos Totales</th>
                            <th class="center">WWCD</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="mvp-content" class="tab-content" style="display:none;margin-top:1rem">
            <h2>MVP Jugadores — <span id="current-phase-2">Clasificatorias</span></h2>
            <div class="table-container">
                <table id="mvp-players-table">
                    <thead>
                        <tr>
                            <th class="center">POS</th>
                            <th class="center"></th>
                            <th>Jugador</th>
                            <th class="center">Equipo</th>
                            <th class="center">Bajas</th>
                            <th class="center">Daño</th>
                            <th class="center">Headshots</th>
                            <th class="center">Total Disparos</th>
                            <th class="center">Total Impactos</th>
                            <th class="center">Precisión (%)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <h2 style="margin-top:2rem">MVT Equipos — <span id="current-phase-3">Clasificatorias</span></h2>
            <div class="table-container">
                <table id="mvt-teams-table">
                    <thead>
                        <tr>
                            <th class="center">POS</th>
                            <th class="center">Logo</th>
                            <th>EQUIPO</th>
                            <th class="center">Puntos por Posición</th>
                            <th class="center">Puntos por Eliminación</th>
                            <th class="center">Puntos Totales</th>
                            <th class="center">WWCD</th>
                            <th class="center">Daño Total</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

    </div>

    <div id="player-details" style="display:none;margin-top:1rem" class="glass-card">
        <h3>Detalles Jugador</h3>
        <div class="stats-grid">
            <div class="glass-card stat-card">Total Disparos<br><strong id="detail-total-shots">0</strong></div>
            <div class="glass-card stat-card">Total Impactos<br><strong id="detail-total-hits">0</strong></div>
            <div class="glass-card stat-card">Precisión<br><strong id="detail-accuracy">0%</strong></div>
        </div>
    </div>
</main>

<script>
function parseCSV(csvText) {
    const lines = [];
    let current = '';
    let inQuotes = false;

    for (let i = 0; i < csvText.length; i++) {
        const char = csvText[i];
        const nextChar = csvText[i + 1];

        if (char === '"' && !inQuotes) {
            inQuotes = true;
        } else if (char === '"' && inQuotes && nextChar === '"') {
            current += '"';
            i++; 
        } else if (char === '"' && inQuotes) {
            inQuotes = false;
        } else if (char === ',' && !inQuotes) {
            current = current.trim();
            if (lines.length === 0) lines.push([]);
            lines[lines.length - 1].push(current);
            current = '';
        } else if (char === '\n' && !inQuotes) {
            current = current.trim();
            if (lines.length === 0) lines.push([]);
            lines[lines.length - 1].push(current);
            lines.push([]);
            current = '';
        } else if (char === '\r') {
            continue;
        } else {
            current += char;
        }
    }
    if (current !== '' || lines.length === 0) {
        current = current.trim();
        if (lines.length === 0) lines.push([]);
        lines[lines.length - 1].push(current);
    }

    if (lines.length > 0 && lines[lines.length - 1].length === 1 && lines[lines.length - 1][0] === '') {
        lines.pop();
    }
    return lines;
}

const phasesConfig = {
    'Clasificatorias': { path: 'data/clasificatorias/', groups: ['GRUPO A','GRUPO B','GRUPO C','GRUPO D'], maps: ['M1','M2','M3','M4','M5','M6','M7','M8','M9'] },
    'Semifinal': { path: 'data/semifinal/', groups: ['SEMIFINAL 1','SEMIFINAL 2'], maps: ['M1','M2','M3'] },
    'Final': { path: 'data/final/', groups: ['FINAL'], maps: ['M1','M2','M3'] }
};

const mapNames = { 'M1':'Erangel','M2':'Miramar','M3':'Sanhok','M4':'Erangel','M5':'Miramar','M6':'Sanhok','M7':'Erangel','M8':'Miramar','M9':'Sanhok' };

let allPlayers = [];
let teamData = {};
let uidToName = {};
let nameToUid = {};
let phaseSelected = 'Clasificatorias';
let semifinalGroupSelected = '1';

function calculatePositionPoints(rank) {
    const pointsMap = {
        1: 10, 2: 6, 3: 5, 4: 4, 5: 3, 6: 2, 7: 2, 8: 1
    };
    return pointsMap[rank] || 0;
}

async function fetchCsv(path){
    try{
        const r = await fetch(path + '?nocache=' + Date.now());
        if(!r.ok) return null;
        const txt = await r.text();
        return parseCSV(txt);
    } catch(e){
        console.error('Error fetching CSV:', e);
        return null;
    }
}

async function loadUIDs(){
    const rows = await fetchCsv('data/uid/uid.csv');
    if(!rows || rows.length < 2) return;
    const header = rows[0].map(h=>h.toLowerCase());
    const uidIdx = header.indexOf('uid');
    const nameIdx = header.indexOf('jugador');
    for(let i=1;i<rows.length;i++){
        const r=rows[i]; if(!r) continue;
        const uid = r[uidIdx]||''; const name = r[nameIdx]||'';
        if(uid) uidToName[uid]=name;
        if(name) nameToUid[name]=uid;
    }
}

const imageExistCache = {};
async function playerImageForUid(uid){
    if(!uid) return 'data/logos/jugadores/default.png';
    if(imageExistCache[uid]) return imageExistCache[uid];
    const paths = [`data/logos/jugadores/${uid}.png`,`data/logos/jugadores/${uid}.jpg`,`data/logos/jugadores/${uid}.webp`];
    for(const p of paths){
        try{
            const r = await fetch(p + '?nocache=' + Date.now(), {method:'HEAD'});
            if(r.ok){
                imageExistCache[uid] = p + '?nocache=' + Date.now();
                return imageExistCache[uid];
            }
        }catch(e){}
    }
    imageExistCache[uid] = 'data/logos/jugadores/default.png';
    return imageExistCache[uid];
}

async function loadAllData(){
    await loadUIDs();
    allPlayers = [];
    teamData = {};
    
    for (const [phase, conf] of Object.entries(phasesConfig)) {
        for (const group of conf.groups) {

            const tasks = conf.maps.map(async (map) => {
                const base = `${conf.path}${group}/${map}.csv`;
                const rows = await fetchCsv(base);
                if (!rows || rows.length < 2) return;

                const header = rows[0];
                const idx = {};
                header.forEach((h, i) => {
                    const key = h.trim();
                    if (key) idx[key] = i;
                });

                const teamMatchData = {};

                for (let r = 1; r < rows.length; r++) {
                    const vals = rows[r];
                    if (!vals || vals.join('').trim() === '') continue;

                    const getVal = (keys) => {
                        for (const k of keys) {
                            if (idx[k] !== undefined && vals[idx[k]] !== undefined) {
                                return vals[idx[k]].trim();
                            }
                        }
                        return '';
                    };

                    const playerName = getVal(['Nombre del Jugador','jugador','Player']) || '';
                    const teamName = getVal(['Nombre del Equipo','equipo','Team']) || '';
                    const uid = getVal(['uId','UID','uid']) || nameToUid[playerName] || '';
                    const kills = parseInt(getVal(['Número de Bajas','Kills']) || '0') || 0;
                    const damage = parseFloat(getVal(['Daño','Damage']) || '0') || 0;
                    const rank = parseInt(getVal(['Rango','Rank']) || '0') || 0;
                    const totalShots = parseInt(getVal(['TotalShots','Total Disparos']) || '0') || 0;
                    const totalHits = parseInt(getVal(['TotalHits','Total Impactos']) || '0') || 0;
                    const headshots = parseInt(getVal(['Número de Headshots','Headshots']) || '0') || 0;

                    const item = { phase, group, map, mapName: mapNames[map] || map, playerName, teamName, uid, kills, damage, rank, totalShots, totalHits, headshots };
                    allPlayers.push(item);

                    if (!teamMatchData[teamName]) teamMatchData[teamName] = {
                        kills: 0, damage: 0, rank: rank,
                        totalShots: 0, totalHits: 0,
                        headshots: 0, wwcd: 0
                    };

                    teamMatchData[teamName].kills += kills;
                    teamMatchData[teamName].damage += damage;
                    teamMatchData[teamName].totalShots += totalShots;
                    teamMatchData[teamName].totalHits += totalHits;
                    teamMatchData[teamName].headshots += headshots;
                    if (rank === 1) teamMatchData[teamName].wwcd = 1;
                }

                for (const [teamName, data] of Object.entries(teamMatchData)) {
                    if (!teamData[teamName]) teamData[teamName] = {
                        name: teamName, players: {},
                        kills: 0, damage: 0, wwcd: 0,
                        positionPoints: 0, totalShots: 0, totalHits: 0
                    };

                    teamData[teamName].kills += data.kills;
                    teamData[teamName].damage += data.damage;
                    teamData[teamName].wwcd += data.wwcd;
                    teamData[teamName].positionPoints += calculatePositionPoints(data.rank);
                    teamData[teamName].totalShots += data.totalShots;
                    teamData[teamName].totalHits += data.totalHits;
                }
            });

            await Promise.all(tasks);
        }
    }
}

function computeStandings(phase, groupFilter = null){
    const players = allPlayers.filter(p =>
        p.phase === phase && (groupFilter === null || p.group === groupFilter)
    );
    
    const teams = {};
    const teamMatchData = {};
    
    players.forEach(p=>{
        const matchKey = `${p.teamName}-${p.group}-${p.map}`;
        if(!teamMatchData[matchKey]) teamMatchData[matchKey] = {kills:0, damage:0, rank:p.rank, wwcd:0};
        teamMatchData[matchKey].kills += p.kills;
        teamMatchData[matchKey].damage += p.damage;
        if(p.rank === 1) teamMatchData[matchKey].wwcd = 1;
    });
    
    for(const [matchKey, data] of Object.entries(teamMatchData)){
        const teamName = matchKey.split('-')[0];
        if(!teams[teamName]) teams[teamName] = {name:teamName,kills:0,damage:0,wwcd:0,positionPoints:0,matches:0};
        teams[teamName].kills += data.kills;
        teams[teamName].damage += data.damage;
        teams[teamName].wwcd += data.wwcd;
        teams[teamName].positionPoints += calculatePositionPoints(data.rank);
        teams[teamName].matches++;
    }
    
    const arr = Object.values(teams).map(t=>({
        ...t,
        pointsByElim:t.kills,
        pointsByPos:t.positionPoints,
        totalPoints:t.positionPoints + t.kills
    }));
    
    arr.sort((a,b)=>{
        if(b.totalPoints!==a.totalPoints) return b.totalPoints - a.totalPoints;
        if(b.wwcd!==a.wwcd) return b.wwcd - a.wwcd;
        if(b.pointsByPos!==a.pointsByPos) return b.pointsByPos - a.pointsByPos;
        return b.pointsByElim - a.pointsByElim;
    });
    return arr;
}

async function renderPositions(phase){
    document.getElementById('current-phase').textContent = phase;
    const tbody = document.querySelector('#positions-table tbody'); 
    tbody.innerHTML='';
    
    if(phase === 'Semifinal'){
        document.getElementById('semifinal-selector').style.display = 'flex';
        await renderSemifinalPositions(semifinalGroupSelected);
        return;
    } else {
        document.getElementById('semifinal-selector').style.display = 'none';
    }
    
    const standings = computeStandings(phase);
    
    if(phase==='Clasificatorias'){
        standings.forEach((t,i)=>{
            const tr = document.createElement('tr');
            if(i<32) tr.classList.add('highlight');
            tr.innerHTML = `<td class="center">${i+1}</td>
                <td class="center"><img class="logo-img" src="data/logos/equipos/${encodeURIComponent(t.name)}.png" onerror="this.src='data/logos/equipos/default.png'"></td>
                <td>${t.name}</td>
                <td class="center">${t.pointsByPos}</td>
                <td class="center">${t.pointsByElim}</td>
                <td class="center">${t.totalPoints}</td>
                <td class="center">${t.wwcd}</td>`;
            tbody.appendChild(tr);
        });
    } else if(phase==='Final'){
        const f = await fetchCsv('data/final/final.csv');
        const finalTeams = (f&&f.length>1)? f.slice(1).map(r=>r[0]) : standings.slice(0,16).map(t=>t.name);
        const finalStand = standings.filter(t=>finalTeams.includes(t.name));
        finalStand.forEach((t,i)=>{
            const tr = document.createElement('tr');
            if(i===0) tr.classList.add('top3-1'); 
            else if(i===1) tr.classList.add('top3-2'); 
            else if(i===2) tr.classList.add('top3-3');
            tr.innerHTML = `<td class="center">${i+1}</td>
                <td class="center"><img class="logo-img" src="data/logos/equipos/${encodeURIComponent(t.name)}.png" onerror="this.src='data/logos/equipos/default.png'"></td>
                <td>${t.name}</td>
                <td class="center">${t.pointsByPos}</td>
                <td class="center">${t.pointsByElim}</td>
                <td class="center">${t.totalPoints}</td>
                <td class="center">${t.wwcd}</td>`;
            tbody.appendChild(tr);
        });
    }
}

async function renderSemifinalPositions(group){
    const tbody = document.querySelector('#positions-table tbody'); 
    tbody.innerHTML='';
    
    const groupName = `SEMIFINAL ${group}`;
    const standings = computeStandings('Semifinal', groupName);
    const groupFile = await fetchCsv(`data/semifinal/semifinal${group}.csv`);
    let groupStand = standings;
    
    if (groupFile && groupFile.length > 1) {
        const groupTeamsFromFile = groupFile.slice(1).map(r => r[0]);
        groupStand = standings.filter(t => groupTeamsFromFile.includes(t.name));
    }
    
    groupStand.forEach((t,i)=>{
        const tr = document.createElement('tr');
        if(i<8) tr.classList.add('highlight');
        tr.innerHTML = `<td class="center">${i+1}</td>
            <td class="center"><img class="logo-img" src="data/logos/equipos/${encodeURIComponent(t.name)}.png" onerror="this.src='data/logos/equipos/default.png'"></td>
            <td>${t.name}</td>
            <td class="center">${t.pointsByPos}</td>
            <td class="center">${t.pointsByElim}</td>
            <td class="center">${t.totalPoints}</td>
            <td class="center">${t.wwcd}</td>`;
        tbody.appendChild(tr);
    });
}

async function renderMVP(phase){
    document.getElementById('current-phase-2').textContent = phase;
    document.getElementById('current-phase-3').textContent = phase;
    
    const tbody = document.querySelector('#mvp-players-table tbody'); 
    tbody.innerHTML='';
    
    const rows = allPlayers.filter(p =>
        p.phase === phase && (phase !== 'Semifinal' || p.group === `SEMIFINAL ${semifinalGroupSelected}`)
    );
    
    const byPlayer = {};
    
    for(const r of rows){
        if(!byPlayer[r.playerName]) byPlayer[r.playerName] = {
            name:r.playerName,
            uid:r.uid||'',
            team:r.teamName,
            kills:0,
            damage:0,
            totalShots:0,
            totalHits:0,
            headshots:0
        };
        byPlayer[r.playerName].kills += r.kills;
        byPlayer[r.playerName].damage += r.damage;
        byPlayer[r.playerName].totalShots += r.totalShots;
        byPlayer[r.playerName].totalHits += r.totalHits;
        byPlayer[r.playerName].headshots += r.headshots;
    }
    
    const arr = Object.values(byPlayer).sort((a,b)=>{
        if(b.kills!==a.kills) return b.kills-a.kills;
        if(b.damage!==a.damage) return b.damage-a.damage;
        return b.headshots-a.headshots;
    });
    
    for(let i=0;i<arr.length;i++){
        const p = arr[i];
        const img = await playerImageForUid(p.uid);
        const acc = p.totalShots>0? (p.totalHits/p.totalShots*100).toFixed(1) : '0.0';
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="center">${i+1}</td>
            <td class="center"><img class="player-img" src="${img}" onerror="this.src='data/logos/jugadores/default.png'"></td>
            <td>${p.name}</td>
            <td class="center">${p.team||'-'}</td>
            <td class="center">${p.kills}</td>
            <td class="center">${Math.round(p.damage)}</td>
            <td class="center">${p.headshots}</td>
            <td class="center">${p.totalShots}</td>
            <td class="center">${p.totalHits}</td>
            <td class="center">${acc}%</td>`;
        tbody.appendChild(tr);
    }
    
    const mvtTbody = document.querySelector('#mvt-teams-table tbody'); 
    mvtTbody.innerHTML='';
    
    let st;
    if(phase === 'Semifinal'){
        const groupName = `SEMIFINAL ${semifinalGroupSelected}`;
        st = computeStandings(phase, groupName);
    } else {
        st = computeStandings(phase);
    }
    
    for(let i=0;i<st.length;i++){
        const t = st[i];
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="center">${i+1}</td>
            <td class="center"><img class="logo-img" src="data/logos/equipos/${encodeURIComponent(t.name)}.png" onerror="this.src='data/logos/equipos/default.png'"></td>
            <td>${t.name}</td>
            <td class="center">${t.pointsByPos}</td>
            <td class="center">${t.pointsByElim}</td>
            <td class="center">${t.totalPoints}</td>
            <td class="center">${t.wwcd}</td>
            <td class="center">${Math.round(t.damage||0)}</td>`;
        mvtTbody.appendChild(tr);
    }
}

function computePhaseMvpMvt(phase){
    const playerAgg = new Map();
    const teamAgg = new Map();
    
    const filteredPlayers = allPlayers.filter(p =>
        p.phase === phase && (phase !== 'Semifinal' || p.group === `SEMIFINAL ${semifinalGroupSelected}`)
    );
    
    const batchSize = 1000;
    for (let i = 0; i < filteredPlayers.length; i += batchSize) {
        const batch = filteredPlayers.slice(i, i + batchSize);
        
        for (const r of batch) {
            if (!playerAgg.has(r.playerName)) {
                playerAgg.set(r.playerName, {
                    name: r.playerName,
                    team: r.teamName,
                    kills: 0,
                    damage: 0,
                    uid: r.uid
                });
            }
            const player = playerAgg.get(r.playerName);
            player.kills += r.kills;
            player.damage += r.damage;
            
            // Procesar equipo
            if (!teamAgg.has(r.teamName)) {
                teamAgg.set(r.teamName, {
                    name: r.teamName,
                    kills: 0,
                    pointsByPos: 0,
                    pointsByElim: 0,
                    totalPoints: 0,
                    wwcd: 0
                });
            }
            const team = teamAgg.get(r.teamName);
            team.kills += r.kills;
            team.pointsByElim += r.kills;
            team.pointsByPos += calculatePositionPoints(r.rank);
            team.totalPoints = team.pointsByPos + team.pointsByElim;
            if (r.rank === 1) team.wwcd++;
        }
    }
    
    let mvp = null;
    for (const player of playerAgg.values()) {
        if (!mvp || player.kills > mvp.kills || (player.kills === mvp.kills && player.damage > mvp.damage)) {
            mvp = player;
        }
    }
    
    let mvt = null;
    for (const team of teamAgg.values()) {
        if (!mvt || team.totalPoints > mvt.totalPoints || (team.totalPoints === mvt.totalPoints && team.wwcd > mvt.wwcd)) {
            mvt = team;
        }
    }
    
    return { mvp, mvt };
}

function setupUI(){
    document.querySelectorAll('.tab').forEach(btn=>btn.addEventListener('click',()=>{
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(c=>c.style.display='none');
        const id = btn.dataset.tab; 
        document.getElementById(id+'-content').style.display = 'block';
    }));
    
    document.querySelectorAll('.phase-btn').forEach(b=>b.addEventListener('click',async()=>{
        document.querySelectorAll('.phase-btn').forEach(x=>x.classList.remove('active')); 
        b.classList.add('active');
        phaseSelected = b.dataset.phase; 
        document.getElementById('current-phase').textContent = phaseSelected; 
        document.getElementById('current-phase-2').textContent = phaseSelected; 
        document.getElementById('current-phase-3').textContent = phaseSelected;
        
        await renderPositions(phaseSelected); 
        await renderMVP(phaseSelected);
        
        const summary = computePhaseMvpMvt(phaseSelected);
        document.getElementById('phase-mvp-name').textContent = summary.mvp? (summary.mvp.name + ' — ' + summary.mvp.kills + ' bajas') : '-';
        document.getElementById('phase-mvp-team').textContent = summary.mvp? (summary.mvp.team || '-') : '';
        document.getElementById('phase-mvp-stats').textContent = summary.mvp? ('Daño: '+Math.round(summary.mvp.damage)) : '';
    }));
    
    document.querySelectorAll('.semifinal-btn').forEach(b=>b.addEventListener('click',async()=>{
        document.querySelectorAll('.semifinal-btn').forEach(x=>x.classList.remove('active')); 
        b.classList.add('active');
        semifinalGroupSelected = b.dataset.group;
        await renderSemifinalPositions(semifinalGroupSelected);
        await renderMVP('Semifinal');
        
        const summary = computePhaseMvpMvt('Semifinal');
        document.getElementById('phase-mvp-name').textContent = summary.mvp? (summary.mvp.name + ' — ' + summary.mvp.kills + ' bajas') : '-';
        document.getElementById('phase-mvp-team').textContent = summary.mvp? (summary.mvp.team || '-') : '';
        document.getElementById('phase-mvp-stats').textContent = summary.mvp? ('Daño: '+Math.round(summary.mvp.damage)) : '';
    }));
}

document.addEventListener('DOMContentLoaded', async()=>{
    await loadAllData();
    setupUI();
    await renderPositions(phaseSelected);
    await renderMVP(phaseSelected);
    
    const s = computePhaseMvpMvt(phaseSelected);
    document.getElementById('phase-mvp-name').textContent = s.mvp? (s.mvp.name + ' — ' + s.mvp.kills + ' bajas') : '-';
    document.getElementById('phase-mvp-team').textContent = s.mvp? (s.mvp.team || '-') : '';
    document.getElementById('phase-mvp-stats').textContent = s.mvp? ('Daño: '+Math.round(s.mvp.damage)) : '';
});

document.getElementById('hamburger').addEventListener('click', function() {
    this.classList.toggle('active');
    document.getElementById('nav-links').classList.toggle('active');
});
</script>
</body>
</html>
